# For raspberry pi 4, 3 or Pi Zero 2 W; or with an external USB dongle!

sudo apt update
sudo apt upgrade

sudo apt install hostapd dnsmasq iptables iptables-persistent
Set NO to save rules.

sudo nano /etc/hostapd/hostapd.conf
# Or wlan1 if using a USB adapter for the AP
# Or a for 5GHz, or ac for 802.11ac if supported
# Choose a clear channel
interface=wlan0
ssid=RPi_4
wpa_passphrase=your_password
hw_mode=g
channel=6
wmm_enabled=1
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

sudo nano /etc/dnsmasq.conf
interface=wlan0
bind-interfaces
dhcp-range=192.168.42.2,192.168.42.20,255.255.255.0,24h
dhcp-option=option:router,192.168.42.1
dhcp-option=option:dns-server,8.8.8.8,8.8.4.4

sudo nano /etc/dhcpcd.conf
denyinterfaces wlan0

sudo nano /etc/systemd/system/ip-forward.service
[Unit]
Description=Enable IP Forwarding
Before=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/sysctl -w net.ipv4.ip_forward=1
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target

sudo systemctl daemon-reload
sudo systemctl enable ip-forward.service
sudo systemctl start ip-forward.service

sudo systemctl unmask hostapd; sudo systemctl enable hostapd; sudo systemctl start hostapd; sudo systemctl enable dnsmasq; sudo systemctl start dnsmasq

sudo nano /etc/systemd/system/wlan0-ap.service
[Unit]
Description=Configure wlan0 for AP mode
Before=hostapd.service
Before=dnsmasq.service
After=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/sbin/ip link set wlan0 up
ExecStart=/usr/sbin/ip addr flush dev wlan0
ExecStart=/usr/sbin/ip addr add 192.168.42.1/24 dev wlan0
ExecStart=/usr/sbin/sysctl -w net.ipv4.ip_forward=1

[Install]
WantedBy=multi-user.target

sudo systemctl daemon-reload; sudo systemctl enable wlan0-ap.service

sudo systemctl edit hostapd
[Unit]
After=wlan0-ap.service
Requires=wlan0-ap.service

sudo systemctl edit dnsmasq
[Unit]
After=wlan0-ap.service hostapd.service
Requires=wlan0-ap.service

# Configure o roteamento para o modem 3G (eth1)
sudo iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE
sudo iptables -A FORWARD -i eth1 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o eth1 -j ACCEPT
# Verifique
sudo iptables -t nat -L -v -n
sudo iptables -L FORWARD -v -n
# Salve as regras
sudo netfilter-persistent save

sudo reboot

