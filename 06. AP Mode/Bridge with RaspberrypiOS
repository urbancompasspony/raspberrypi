# For raspberry pi 4, 3 or Pi Zero 2 W; or with an external USB dongle!

sudo apt update
sudo apt upgrade

sudo apt install hostapd dnsmasq

sudo nano /etc/hostapd/hostapd.conf
# Or wlan1 if using a USB adapter for the AP
# Or a for 5GHz, or ac for 802.11ac if supported
# Choose a clear channel
interface=wlan0
ssid=RPi_4
wpa_passphrase=your_password
hw_mode=g
channel=6
wmm_enabled=1
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

sudo nano /etc/dnsmasq.conf
interface=wlan0
dhcp-range=192.168.42.2,192.168.42.20,255.255.255.0,24h
dhcp-option=option:router,192.168.42.1
dhcp-option=option:dns-server,8.8.8.8,8.8.4.4

sudo nano /etc/dhcpcd.conf
denyinterfaces wlan0

sudo nano /etc/sysctl.conf
net.ipv4.ip_forward=1

sudo sysctl -p

sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT

sudo systemctl unmask hostapd; sudo systemctl enable hostapd; sudo systemctl start hostapd; sudo systemctl enable dnsmasq; sudo systemctl start dnsmasq

sudo nano /etc/systemd/system/wlan0-ap.service
[Unit]
Description=Configure wlan0 for AP mode
Before=hostapd.service
Before=dnsmasq.service
After=network.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/sbin/ip link set wlan0 up
ExecStart=/usr/sbin/ip addr flush dev wlan0
ExecStart=/usr/sbin/ip addr add 192.168.42.1/24 dev wlan0

[Install]
WantedBy=multi-user.target

sudo systemctl daemon-reload; sudo systemctl enable wlan0-ap.service

sudo systemctl edit hostapd
[Unit]
After=wlan0-ap.service
Requires=wlan0-ap.service

sudo systemctl edit dnsmasq
[Unit]
After=wlan0-ap.service hostapd.service
Requires=wlan0-ap.service

sudo reboot


# SE DER ERRO DE IP NAO ENCONTRADO E:
Nov 16 11:45:11 raspberrypi dnsmasq-dhcp[948]: DHCP packet received on wlan0 which has no address

sudo systemctl stop hostapd
sudo systemctl stop dnsmasq

sudo ip addr flush dev wlan0
sudo ip addr add 192.168.42.1/24 dev wlan0
sudo ip link set wlan0 up

sudo systemctl start hostapd
sleep 3
sudo systemctl start dnsmasq
